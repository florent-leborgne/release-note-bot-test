---
name: Approve Release Note

on:
  issue_comment:
    types: [edited]

jobs:
  check-approval:
    runs-on: ubuntu-latest
    # Only run on PR comments (not issue comments) that contain the bot marker
    if: >-
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '<!-- release-note-bot -->')
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Check approval checkbox
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body;
            const prNumber = context.payload.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const isApproved = body.includes('- [x] **Approved**') || body.includes('- [X] **Approved**');
            const wasApproved = body.includes('release-note:approved');

            // Extract the release note text between markers
            const match = body.match(/<!-- RELEASE_NOTE_START -->\n([\s\S]*?)\n<!-- RELEASE_NOTE_END -->/);
            const releaseNote = match ? match[1].trim() : null;

            if (isApproved) {
              core.info(`Release note approved for PR #${prNumber}`);

              if (releaseNote) {
                core.info(`Release note text:\n${releaseNote}`);
              }

              // Add the approved label
              try {
                await github.rest.issues.addLabels({
                  owner, repo,
                  issue_number: prNumber,
                  labels: ['release-note:approved']
                });
                core.info('Added release-note:approved label');
              } catch (e) {
                core.warning(`Could not add label: ${e.message}`);
              }
            } else {
              core.info(`Approval checkbox not checked for PR #${prNumber}, skipping.`);

              // If the checkbox was unchecked, remove the label
              try {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: prNumber,
                  name: 'release-note:approved'
                });
                core.info('Removed release-note:approved label');
              } catch (e) {
                // Label might not exist, that's fine
                if (e.status !== 404) {
                  core.warning(`Could not remove label: ${e.message}`);
                }
              }
            }
